<div class="container mt-3">
    <!-- Input group with search -->
    <div class="input-group mb-3">
        <input id="typeahead-basic" type="text" class="form-control bg-dark text-light border-secondary"
            [(ngModel)]="searchTerm" [ngbTypeahead]="search" [resultTemplate]="rt" [inputFormatter]="formatter"
            (selectItem)="selectItem($event)" placeholder="Search for books..." />
        <!-- Clear selection button -->
        <button class="btn btn-danger" *ngIf="selectedBooks && selectedBooks.length > 0" (click)="clearSelection()">
            <fa-icon [icon]="clearIcon"></fa-icon>
        </button>

        <!-- Barcode Scanner Component -->
        <app-barcode-scanner (isbnScanned)="onIsbnScanned($event)"></app-barcode-scanner>
    </div>

    <!-- Typeahead result template -->
    <ng-template #rt let-r="result" let-t="term">
        <img *ngIf="r.volumeInfo.imageLinks && r.volumeInfo.imageLinks.smallThumbnail"
            [src]="r.volumeInfo.imageLinks.smallThumbnail" class="me-1" style="width: 48px" />
        <ngb-highlight [result]="r.volumeInfo.title" [term]="t"></ngb-highlight>
    </ng-template>

    <!-- Error message -->
    <div *ngIf="searchFailed" class="alert alert-danger mt-3">Search failed</div>

    <!-- Display selected books -->
    <div *ngIf="selectedBooks.length > 0">
        <h2 class="text-light mt-3">Search Results</h2>
        <div *ngFor="let book of selectedBooks" class="mb-2">
            <app-book-card [book]="book" [inCollection]="inCollection(book)" [status]="getBookStatus(book)"
                (save)="saveBook(book)" (delete)="deleteBook(book.id)"></app-book-card>
        </div>
    </div>

    <!-- Display saved books -->
    <div>
        <h2 class="text-light mt-3">My Collection</h2>

        <!-- Filter Controls -->
        <div class="row mb-3">
            <div class="col-8">
                <input type="text" class="form-control bg-dark border-secondary text-light"
                    placeholder="Search by title or ISBN..." [(ngModel)]="filterTerm"
                    (ngModelChange)="onFilterChange()" />
            </div>
            <div class="col-4">
                <select class="form-control bg-dark border-secondary text-light" [(ngModel)]="filterStatus"
                    (change)="onFilterChange()">
                    <option value="" selected>All</option>
                    <option *ngFor="let status of statuses" [value]="status">
                        {{ statusFormatter(status) | titlecase }}
                    </option>
                </select>
            </div>
        </div>

        <div class="row" *ngIf="savedBooks.length > 0">
            <div class="col-12 mb-2 col-md-6 mb-3" *ngFor="let item of savedBooks">
                <app-book-card [book]="item.collectibleItem" [inCollection]="true" [status]="item.status"
                    (delete)="deleteBook(item.collectibleItemId)"
                    (searchByTitle)="setTitle($event)"></app-book-card>
            </div>

            <!-- Pagination -->
            <div class="col-12" *ngIf="totalItems > pageSize">
                <ngb-pagination [collectionSize]="totalItems" [(page)]="page" [pageSize]="pageSize"
                    [maxSize]="5" [rotate]="true" [boundaryLinks]="true" [ellipses]="true" (pageChange)="onPageChange($event)">
                </ngb-pagination>
            </div>
        </div>
    </div>
    <div *ngIf="savedBooks.length === 0 && (filterTerm || filterStatus)" class="text-light">
        <p>No books match your filter criteria.</p>
    </div>
</div>